name: CD - Deploy Frontend

on:
  workflow_run:
    workflows: ["CI - Build and Push Frontend Image"]
    types: [completed]
    branches: ["main"]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]
    # Solo desplegar si el CI fue exitoso
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Ver contexto del cluster
        run: kubectl config current-context

      - name: Validar nodos
        run: kubectl get nodes -o wide

      - name: Update deployment image
        run: |
          kubectl set image deployment/frontend-seminario \
            frontend-seminario=kennyadg/frontend-seminario:${{ github.event.workflow_run.head_sha }} \
            -n microservices
          
      - name: Wait for rollout to complete
        run: |
          kubectl rollout status deployment/frontend-seminario -n microservices --timeout=5m