name: CD - Deploy Frontend

on:
  workflow_run:
    workflows: ["CI - Build and Push Frontend Image"]
    types: [completed]
    branches: ["main"]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set IMAGE_TAG from triggering workflow
        run: echo "IMAGE_TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV

      - name: Verify cluster context
        run: |
          kubectl config current-context
          kubectl get nodes -o wide

      # ğŸš€ Actualizar el tag de la imagen dinÃ¡micamente
      - name: Update deployment image tag
        run: |
          echo "ğŸ”„ Actualizando tag de imagen en deployment.yaml..."
          sed -i "s|kennyadg/frontend-seminario:latest|kennyadg/frontend-seminario:${IMAGE_TAG}|g" k8s/frontend/deployment.yaml
          echo "âœ… Tag actualizado a ${IMAGE_TAG}"

      # ğŸš€ Aplicar manifiestos actualizados
      - name: Apply updated manifests
        run: |
          echo "ğŸ“¦ Aplicando manifiestos..."
          kubectl apply -f k8s/frontend/
          echo "âœ… Manifiestos aplicados"

      # â³ Esperar rollout
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/frontend-seminario -n microservices --timeout=300s
          echo "âœ… Deployment completado"

      # ğŸ§¾ Verificar versiÃ³n desplegada
      - name: Verify deployed image
        run: |
          echo "ğŸ–¼ï¸ Imagen desplegada:"
          kubectl get pods -l app=frontend-seminario -n microservices -o jsonpath='{.items[0].spec.containers[0].image}'
          echo ""
